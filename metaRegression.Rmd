# Meta-regression

Estimate meta-regression models for log transformed incidence rate.

Two outcomes are modeled separately.

1. AML or MDS secondary malignancies
1. Non-breast solid secondary malignancies

Cumulative doses are dichotomized into low and high doses.

* Cyclophosphamide
    * $\lt 2400$
    * $\ge 2400$
* Taxane
    * $\lt 500$
    * $\ge 500$

```{r}
xscale <- 1e3
D2 <- D1[,
         .(id = factor(id),
           authorYear,
           isCyclo,
           xCyc = cyclophosphamideCumulDose / xscale,  # scale units
           isCycHighDose = cyclophosphamideCumulDose >= 2400,
           xTax = taxaneCumulDose / 1e2,  # scale units
           isTaxHighDose = ifelse(taxaneCumulDose >= 500 & isTaxane == TRUE, TRUE, FALSE),
           isAnthra,
           isTaxane,
           isFluoro,
           nITT,
           medianFU,
           malType,
           malN,
           py,
           rate)]
D2 <- D2[isTaxane == FALSE, isTaxHighDose := FALSE]
D2 <- D2[!(is.na(xCyc) | is.na(isCycHighDose) | is.na(isTaxHighDose))]
```

The effect of cyclophosphamide could be due to high dose taxanes in the regimen.

> From: Joy Melnikow [mailto:jamelnikow@ucdavis.edu]   
> Sent: Monday, August 01, 2016 2:47 PM  
> To: Benjamin Chan <chanb@ohsu.edu>  
> Subject: RE: secondary malignancies  
> 
> The one I'm asking about is cyclophosphamide with high dose taxane vs
> cyclophosphamide alone.  I think if it looks like taxane augments the known
> risk of cyclophosphamide this would be an important addition to the
> literature.

Four model are estimated.

1. $$\frac{y_i}{t_i} = \beta_0 + \beta_1 x_{\text{cyclophosphamide dose}, i} + \beta_2 I_{\text{high dose taxane}, i} + \sigma_\text{study}$$
1. $$\frac{y_i}{t_i} = \beta_0 + \beta_1 x_{\text{cyclophosphamide dose}, i} + \beta_2 I_{\text{high dose taxane}, i} + \gamma x_{\text{cyclophosphamide dose}, i} I_{\text{high dose taxane}, i} + \sigma_\text{study}$$
1. $$\frac{y_i}{t_i} = \beta_0 + \beta_1 I_{\text{high dose cyclophosphamide}, i} + \beta_2 I_{\text{high dose taxane}, i} + \sigma_\text{study}$$
1. $$\frac{y_i}{t_i} = \beta_0 + \beta_1 I_{\text{high dose cyclophosphamide}, i} + \beta_2 I_{\text{high dose taxane}, i} + \gamma I_{\text{high dose cyclophosphamide}, i} I_{\text{high dose taxane}, i} + \sigma_\text{study}$$

Models were estimated using the `rma.mv()` function from the metafor` package for R.

```{r}
library(metafor)
citation("metafor")
```

Define meta-regression functions.


```{r}
pvalToChar <- function (p) {
  if (p < 0.001) {
    pvalue <- "p < 0.001"
  } else {
    pvalue <- sprintf("p = %.03f", p)
  }
  pvalue
}
metareg <- function (D) {
  require(metafor)
  xData <- unique(D[, .(xCyc, isCycHighDose, isTaxHighDose, malType)])
  D <- escalc("IRLN", xi = malN, ti = py, data = D)
  randomEffect <- list(~ 1 | id)
  MLin <- rma.mv(yi ~ xCyc + isTaxHighDose,
                 vi,
                 random = randomEffect,
                 data = D)
  MLinInt <- rma.mv(yi ~ xCyc + isTaxHighDose + xCyc * isTaxHighDose,
                    vi,
                    random = randomEffect,
                    data = D)
  MBin <- rma.mv(yi ~ isCycHighDose + isTaxHighDose,
                 vi,
                 random = randomEffect,
                 data = D)
  MBinInt <- rma.mv(yi ~ isCycHighDose + isTaxHighDose + isCycHighDose * isTaxHighDose,
                    vi,
                    random = randomEffect,
                    data = D)
  list(rmaLin = MLin,
       rmaLinInt = MLinInt,
       rmaBin = MBin,
       rmaBinInt = MBinInt)
}
plotreg <- function (M, D, title) {
  require(ggplot2)
  require(RColorBrewer)
  require(data.table)
  X <- data.table(M$X)
  X <- unique(X)
  varnames <- names(X)[2:ncol(X)]
  X0 <- data.table(x1 = seq(min(X[isTaxHighDoseTRUE == 0, xCyc]), max(X[isTaxHighDoseTRUE == 0, xCyc]),
                            length.out = 100),
                   x2 = rep(0, 100))
  X1 <- data.table(x1 = seq(min(X[isTaxHighDoseTRUE == 1, xCyc]), max(X[isTaxHighDoseTRUE == 1, xCyc]),
                            length.out = 100),
                   x2 = rep(1, 100))
  X <- rbind(X0, X1)
  names(X) <- varnames
  X$xCyc <- round(X$xCyc, digits = 1)
  X <- unique(X)
  yhat <- data.table(malType = mal,
                     X,
                     # variable = "pred",
                     pred = predict(M, as.matrix(X), transf = exp)[["pred"]] * scale)
  ci.lb <- data.table(malType = mal,
                      X,
                      # variable = "ci.lb",
                      ci.lb = predict(M, as.matrix(X), transf = exp)[["ci.lb"]] * scale)
  ci.ub <- data.table(malType = mal,
                      X,
                      # variable = "ci.ub",
                      ci.ub = predict(M, as.matrix(X), transf = exp)[["ci.ub"]] * scale)
  keyvar <- c("malType", "xCyc", "isTaxHighDoseTRUE")
  setkeyv(yhat, keyvar)
  setkeyv(ci.lb, keyvar)
  setkeyv(ci.ub, keyvar)
  yhat <- merge(merge(yhat, ci.lb), ci.ub)
  pvalues <- c(M$pval[which(row.names(M$b) == "isTaxHighDoseTRUE")])
  pal <- brewer.pal(5, name = "Set1")[c(1, 2)]
  G <- ggplot(D, aes(x = xCyc * xscale,
                     y = rate + 1/2,
                     size = nITT / min(nITT, na.rm = TRUE),
                     color = isTaxHighDose))
  G <- G + geom_point(alpha = 1/2,
                      position = "jitter")
  G <- G + geom_line(data = yhat[isTaxHighDoseTRUE == 0, ],
                     aes(x = xCyc * xscale, y = pred),
                     inherit.aes = FALSE,
                     color = pal[1])
  G <- G + geom_line(data = yhat[isTaxHighDoseTRUE == 1, ],
                     aes(x = xCyc * xscale, y = pred),
                     inherit.aes = FALSE,
                     color = pal[2])
  G <- G + geom_ribbon(data = yhat[isTaxHighDoseTRUE == 0, ],
                       aes(x = xCyc * xscale, ymax = ci.ub, ymin = ci.lb),
                       inherit.aes = FALSE,
                       fill = pal[1],
                       alpha = 1/8)
  G <- G + geom_ribbon(data = yhat[isTaxHighDoseTRUE == 1, ],
                       aes(x = xCyc * xscale, ymax = ci.ub, ymin = ci.lb),
                       inherit.aes = FALSE,
                       fill = pal[2],
                       alpha = 1/8)
  G <- G + scale_x_log10("Cyclophosphamide cumulative dose",
                         breaks = 1e3 * c(0.5, 1, 2, 4, 8, 16))
  G <- G + scale_y_log10(sprintf("Rate per %s person-years",
                                 format(scale, big.mark = ",")))
  G <- G + scale_color_manual(sprintf("Taxane\n(%s)", pvalToChar(pvalues[c(1)])),
                              values = pal,
                              labels = c("None or low dose", "High dose"))
  G <- G + scale_size_continuous(guide = FALSE)
  G <- G + labs(title = title)
  G <- G + theme_bw()
  filename <- sprintf("%s_Cyclophosphamide_byHighDoseTaxane",
                      gsub("(\\s)|(-)", "", title))
  ggsave(filename = sprintf("%s.png", filename), width = 9)
  yhat$xCyc <- yhat$xCyc * xscale
  write.csv(D, file = sprintf("%s.csv", filename), row.names = FALSE, quote = FALSE)
  write.csv(yhat, file = sprintf("%s_Pred.csv", filename), row.names = FALSE, quote = FALSE)
  show(file.info(grep(paste0(filename, "(_Pred)*\\."), list.files(), value = TRUE))[c("size", "mtime")])
  G
}
```

## AML/MDS

```{r}
mal <- "AML or MDS"
D3 <- D2[malType == mal]
D3 <- D3[!(is.na(rate) | is.na(nITT) | is.na(malType))]
M <- metareg(D3)
```

### Findings

* `r mal` rate had a dose response relationship with cumulative cyclophosphamide dose
  * `r mal` rate increased `r sprintf("%.03g", exp(M$rmaLin$b[which(row.names(M$rmaLin$b) == "xCyc")]))` times (95% CI: `r sprintf("%.03g", exp(M$rmaLin$ci.lb[which(row.names(M$rmaLin$b) == "xCyc")]))`, `r sprintf("%.03g", exp(M$rmaLin$ci.ub[which(row.names(M$rmaLin$b) == "xCyc")]))`; p = `r sprintf("%.03g", M$rmaLin$pval[which(row.names(M$rmaLin$b) == "xCyc")])`) for each `r xscale` $\text{mg} / \text{m}^2$
* High dose taxane confounded the cyclophosphamide dose response
  * High dose taxane increased `r mal` rate by `r sprintf("%.03g", exp(M$rmaLin$b[which(row.names(M$rmaLin$b) == "isTaxHighDoseTRUE")]))` times (95% CI: `r sprintf("%.03g", exp(M$rmaLin$ci.lb[which(row.names(M$rmaLin$b) == "isTaxHighDoseTRUE")]))`, `r sprintf("%.03g", exp(M$rmaLin$ci.ub[which(row.names(M$rmaLin$b) == "isTaxHighDoseTRUE")]))`; p = `r sprintf("%.03g", M$rmaLin$pval[which(row.names(M$rmaLin$b) == "isTaxHighDoseTRUE")])`)
* High dose taxane did not modify the dose response effect of cyclophosphamide
  * Interaction term estimate was `r sprintf("%.03g", M$rmaLinInt$b[which(row.names(M$rmaLinInt$b) == "xCyc:isTaxHighDoseTRUE")])` (95% CI: `r sprintf("%.03g", M$rmaLinInt$ci.lb[which(row.names(M$rmaLinInt$b) == "xCyc:isTaxHighDoseTRUE")])`, `r sprintf("%.03g", M$rmaLinInt$ci.ub[which(row.names(M$rmaLinInt$b) == "xCyc:isTaxHighDoseTRUE")])`; p = `r sprintf("%.03g", M$rmaLinInt$pval[which(row.names(M$rmaLinInt$b) == "xCyc:isTaxHighDoseTRUE")])`)

### Cyclophosphamide: dose response; Taxane: confounder

```{r, fig.width = 9}
M$rmaLin
plotreg(M$rmaLin, D3, mal)
```

### Cyclophosphamide: dose response; Taxane: effect modifier

```{r}
M$rmaLinInt
```

### Cyclophosphamide: dichotomous; Taxane: confounder

```{r}
M$rmaBin
```

### Cyclophosphamide: dichotomous; Taxane: effect modifier

```{r}
M$rmaBinInt
```


## Non-Breast Solid

```{r}
mal <- "Non-Breast Solid"
D3 <- D2[malType == mal]
D3 <- D3[!(is.na(rate) | is.na(nITT) | is.na(malType))]
M <- metareg(D3)
```

* `r mal` rate did not have a dose response relationship with cumulative cyclophosphamide dose
  * `r mal` rate increased `r sprintf("%.03g", exp(M$rmaLin$b[which(row.names(M$rmaLin$b) == "xCyc")]))` times (95% CI: `r sprintf("%.03g", exp(M$rmaLin$ci.lb[which(row.names(M$rmaLin$b) == "xCyc")]))`, `r sprintf("%.03g", exp(M$rmaLin$ci.ub[which(row.names(M$rmaLin$b) == "xCyc")]))`; p = `r sprintf("%.03g", M$rmaLin$pval[which(row.names(M$rmaLin$b) == "xCyc")])`) for each `r xscale` $\text{mg} / \text{m}^2$
* High dose taxane did not confound the cyclophosphamide dose response
  * High dose taxane increased `r mal` rate by `r sprintf("%.03g", exp(M$rmaLin$b[which(row.names(M$rmaLin$b) == "isTaxHighDoseTRUE")]))` times (95% CI: `r sprintf("%.03g", exp(M$rmaLin$ci.lb[which(row.names(M$rmaLin$b) == "isTaxHighDoseTRUE")]))`, `r sprintf("%.03g", exp(M$rmaLin$ci.ub[which(row.names(M$rmaLin$b) == "isTaxHighDoseTRUE")]))`; p = `r sprintf("%.03g", M$rmaLin$pval[which(row.names(M$rmaLin$b) == "isTaxHighDoseTRUE")])`)

### Cyclophosphamide: dose response; Taxane: confounder

```{r, fig.width = 9}
M$rmaLin
plotreg(M$rmaLin, D3, mal)
```

### Cyclophosphamide: dose response; Taxane: effect modifier

```{r}
M$rmaLinInt
```

### Cyclophosphamide: dichotomous; Taxane: confounder

```{r}
M$rmaBin
```

### Cyclophosphamide: dichotomous; Taxane: effect modifier

```{r}
M$rmaBinInt
```
